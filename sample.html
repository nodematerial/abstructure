<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>aaa</title>
    <style>* { padding: 0; margin: 0; } canvas { background: #555; display: block; margin: 0 auto; }</style>
    <script type="text/javascript" src="arrow.js"></script>
</head>
<body>
    <canvas id="myCanvas" width="1000" height="550"></canvas>

    <script>
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        var x = canvas.width/2;
        var y = canvas.height/2;
        var move = 80
        var near = 18;
        var far = 50;
        var char = ''
        var fontsize = 26
        var arrow_mode = 1;
        var max_arrow_mode = 2; 
        var arrow_transparency = 0.2;
        var charcluster = []
        var linecluster = []
        var charlist = [];
        var linelist = [];
        var arr = ['a','b','c','d','e','f','g','h','i','j','k','l','m',
        'n','o','p','q','r','s','t','u','v','w','x','y','z',
        'A','B','C','D','E','F','G','H','I','J','K','L','M', 
        'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
        '1','2','3','4','5','6','7','8','9','10','_'];

        document.addEventListener("keydown", keyDownHandler, false);

        function mode1(e){
            if(e.code  == "ArrowRight") {
                linelist.push([x,y]);
                x += move;
                charlist.push(char);
                char = '';
                fontsize = fontsize;
            }
            else if(e.code == 'ArrowLeft') {
                linelist.push([x,y]);
                x -= move;
                charlist.push(char);
                char = '';
                fontsize = fontsize;
            }
            else if(e.code == 'ArrowUp') {
                linelist.push([x,y]);
                y -= move;
                charlist.push(char);
                char = '';
                fontsize = fontsize;
            }
            else if(e.code == 'ArrowDown') {
                linelist.push([x,y]);
                y += move;
                charlist.push(char);
                char = '';
                fontsize = fontsize;
            }
            //toggle arrow mode
            else if(e.key == '/'){
                arrow_mode++;
                if (arrow_mode > max_arrow_mode){
                    arrow_mode = 1;
                }
            }
            else if(arr.includes(e.key)){
                char += e.key
            }
            else if(e.code == 'Backspace'){
                if (char != ''){
                }
                char = char.slice(0, -1)
            }
            else{}
        }
        function mode2(e){
            if(e.code  == "ArrowRight") {
                x += move;
            }
            else if(e.code == 'ArrowLeft') {
                x -= move;
            }
            else if(e.code == 'ArrowUp') {
                y -= move;
            }
            else if(e.code == 'ArrowDown') {
                y += move;
            }
        }
        function keyDownHandler(e) {
            //2つのモードを行き来する、切り替わる瞬間に特別な処理を入れる
            if (linelist.some(item => item[0] === x && item[1] === y)){
                if (mode_now == 1){
                    mode_now = 0;
                }
                mode2(e);
            }
            else{
                if (mode_now == 0){
                    mode_now = 1;
                    linecluster.push(linelist);
                    charcluster.push(charlist);
                    linelist = []
                    charlist = []
                }
                mode1(e);
            }
        }

        function drawBall(x,y) {
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI*2);
            ctx.fillStyle = "#0095DD";
            ctx.fill();
            ctx.closePath();
        }

        function draw_list_components(linelist,charlist){
            if (linelist.length!=0){
                    x_ = linelist[0][0],
                    y_ = linelist[0][1],
                    char_ = charlist[0];
                    drawChar(x_, y_, char_, fontsize-3*char_.length);
                }
            for(i=0; i<linelist.length-1; i++){
                var pre_x = linelist[i][0],
                    pre_y = linelist[i][1],
                    now_x = linelist[i+1][0],
                    now_y = linelist[i+1][1];
                    pre2_char = charlist[i]
                    pre_char = charlist[i+1];
                drawChar(now_x, now_y, pre_char, fontsize-3*pre_char.length);
                if (pre2_char != ''){
                    pre_x = pre_x*0.8+now_x*0.2;
                    pre_y = pre_y*0.8+now_y*0.2;
                }
                if (pre_char != ''){
                    now_x = pre_x*0.2+now_x*0.8;
                    now_y = pre_y*0.2+now_y*0.8;
                }
                ctx.beginPath();
                ctx.moveTo(pre_x, pre_y);
                ctx.lineTo(now_x, now_y);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.closePath();
            }
        }

        function draw_all_components() {
            for (i=0; i<linecluster.length; i++){
                line_list = linecluster[i];
                char_list = charcluster[i];
                draw_list_components(line_list, char_list)
            }
            draw_list_components(linelist, charlist)
        }

        function drawChar(x, y, char, fontsize) {
            var size = fontsize;
            ctx.font =`${fontsize}px serif`;
            var measure = ctx.measureText(char);
            var width = measure.width;
            var height = measure.actualBoundingBoxAscent + measure.actualBoundingBoxDescent;
            ctx.beginPath();
            ctx.fillText(char, x-width/2, y+height/2);
            ctx.fill();
            ctx.closePath();
        }

        function drawArrow1(x,y,near,far) {
            var transparency = arrow_transparency;
            ctx.beginPath();
            ctx.arrow(x+near, y, x+far, y, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near, y, x-far, y, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x, y+near, x, y+far, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x, y-near, x, y-far, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x+near*0.65, y+near*0.65, x+far*0.65, y+far*0.65, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near*0.65, y+near*0.65, x-far*0.65, y+far*0.65, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x+near*0.65, y-near*0.65, x+far*0.65, y-far*0.65, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near*0.65, y-near*0.65, x-far*0.65, y-far*0.65, [0, 3, -10, 3, -10, 8]);
            ctx.strokeStyle = `rgba(0, 0, 0, ${transparency})`;
            ctx.lineWidth = 1 ;
            ctx.stroke();
            ctx.closePath();
        }

        function drawArrow2(x,y,near,far) {
            var transparency = arrow_transparency
            ctx.beginPath();
            ctx.arrow(x+near, y, x+far, y, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near, y, x-far, y, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x, y+near, x, y+far, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x, y-near, x, y-far, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x+near*0.8, y+near*0.45, x+far*0.8, y+far*0.45, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near*0.8, y+near*0.45, x-far*0.8, y+far*0.45, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x+near*0.8, y-near*0.45, x+far*0.8, y-far*0.45, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near*0.8, y-near*0.45, x-far*0.8, y-far*0.45, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x+near*0.45, y+near*0.8, x+far*0.45, y+far*0.8, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near*0.45, y+near*0.8, x-far*0.45, y+far*0.8, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x+near*0.45, y-near*0.8, x+far*0.45, y-far*0.8, [0, 3, -10, 3, -10, 8]);
            ctx.arrow(x-near*0.45, y-near*0.8, x-far*0.45, y-far*0.8, [0, 3, -10, 3, -10, 8]);
            ctx.strokeStyle = `rgba(0, 0, 0, ${transparency})`;
            ctx.stroke();
            ctx.closePath();
        }

        function toggle_arrow(){
            if (arrow_mode == 1){
                drawArrow1(x,y,near,far);
            }
            else if (arrow_mode == 2){
                drawArrow2(x,y,near,far);
            }
        }

        function main(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            //drawBall(x,y);
            drawChar(x, y, char, fontsize-3*char.length)
            draw_all_components();
            toggle_arrow(x,y,near,far);
            requestAnimationFrame(main);
        }

        main();
    </script>

</body>
</html>
